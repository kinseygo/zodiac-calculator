<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<title>生肖自动计算器 v1.2.2（完全修正版）</title>
<link rel="stylesheet" href="style.css" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon.png">
</head>
<body>
<div class="container">
<h1>生肖自动计算器 v1.2.2（完全修正版）</h1>
<div class="controls">
<label>选择年份（公历，≥2025）：<select id="yearSelect"></select></label>
<button id="clearBtn">清空</button>
<button id="randomBtn">随机填值</button>
<button id="exportBtn">导出 CSV</button>
</div>

<table id="zodiacTable">
<thead><tr><th>生肖</th><th>对应年龄</th><th>输入</th><th>选中</th></tr></thead>
<tbody id="tbody"></tbody>
</table>

<div class="summary">
<span>总和：<strong id="totalSum">0</strong></span>
<span>当前农历生肖：<strong id="yearZodiac"></strong></span>
<span>选中：<strong id="selectedZodiacLabel">—</strong></span>
<span id="resultBadge">—</span>
</div>

<div class="hint">生肖以中国农历周岁计算（春节前属上一年生肖，春节后属当年生肖）</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/lunar-javascript@2.0.0/dist/lunar.min.js"></script>

<script>
(function(){
const zodiacs=['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪'];
const yearSelect=document.getElementById('yearSelect');
for(let y=2025;y<=2050;y++){let o=document.createElement('option');o.value=y;o.textContent=y;yearSelect.appendChild(o);}
yearSelect.value=2025;
const tbody=document.getElementById('tbody');

// ✅ 修正版：使用 Solar.fromYmd 转 Lunar
function getLunarZodiac(year){
  const solar = Solar.fromYmd(year, 1, 1);
  const lunar = solar.getLunar();
  const zodiac = lunar.getZodiac();
  return { name: zodiac, idx: zodiacs.indexOf(zodiac) };
}

function parseExpr(e){if(!e)return 0;if(!/^[0-9+\-*/().\s]+$/.test(e))return 0;try{return Function('return('+e+')')();}catch{return 0;}}

function gen(){
  const year=parseInt(yearSelect.value);
  const yz=getLunarZodiac(year);
  document.getElementById('yearZodiac').textContent=yz.name+'('+year+')';

  const agesByZodiac = Array.from({length:12},()=>[]);
  for(let age=1; age<=49; age++){
    const birthYear = year - age;
    const birthSolar = Solar.fromYmd(birthYear, 7, 1);
    const birthLunar = birthSolar.getLunar();
    const zname = birthLunar.getZodiac();
    const idx = zodiacs.indexOf(zname);
    agesByZodiac[idx].push(age);
  }

  tbody.innerHTML='';
  for(let i=0;i<12;i++){
    const tr=document.createElement('tr');
    tr.innerHTML='<td>'+zodiacs[i]+'</td><td>'+agesByZodiac[i].join(',')+'</td><td><input class="expr" data-i="'+i+'" /></td><td><input type="radio" name="sel" value="'+i+'"></td>';
    tbody.appendChild(tr);
  }
  calc();
}

function calc(){
  const inputs=document.querySelectorAll('.expr');
  let t=0,rowValues=[];
  inputs.forEach(i=>{let val=parseExpr(i.value.trim());rowValues.push(val);t+=val;});
  document.getElementById('totalSum').textContent=t;
  const selectedRadio=document.querySelector('input[name=sel]:checked');
  const year=parseInt(yearSelect.value);
  const yz=getLunarZodiac(year);
  let result=null;
  if(selectedRadio){
    const idx=parseInt(selectedRadio.value);
    const multiplier=(idx===yz.idx)?8:10;
    result=t-rowValues[idx]*multiplier;
    document.getElementById('selectedZodiacLabel').textContent=zodiacs[idx]+'(x'+multiplier+')';
  } else {document.getElementById('selectedZodiacLabel').textContent='—';}
  const badge=document.getElementById('resultBadge');
  if(result===null){badge.textContent='请选择生肖';badge.className='even';}
  else{badge.textContent=(result>0?'盈 ':'亏 ')+result;badge.className=result>0?'profit':(result<0?'loss':'even');}
}

yearSelect.onchange=gen;
document.body.addEventListener('input',calc);
document.body.addEventListener('change',calc);
document.getElementById('clearBtn').onclick=()=>{document.querySelectorAll('.expr').forEach(i=>i.value='');document.querySelectorAll('input[name=sel]').forEach(i=>i.checked=false);calc();};
document.getElementById('randomBtn').onclick=()=>{document.querySelectorAll('.expr').forEach(i=>i.value=Math.floor(Math.random()*1000)+1);calc();};
document.getElementById('exportBtn').onclick=()=>{
  let rows=[['生肖','年龄','输入','选中']];
  document.querySelectorAll('#tbody tr').forEach(tr=>{rows.push(Array.from(tr.children).slice(0,4).map(td=>td.innerText));});
  let blob=new Blob([rows.map(r=>r.join(',')).join('\n')],{type:'text/csv'});
  let a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='zodiac_lunar_app.csv';a.click();
};
gen();
})();
</script>
</body>
</html>
